<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP8266 Control Panel</title>
  <style>
    :root {
      --bg-color: #f0f2f5;
      --window-bg: #ffffff;
      --text-main: #1c1e21;
      --text-secondary: #606770;
      --border-color: #dddfe2;
      --primary-blue: #1877f2;
      --success-green: #42b72a;
      --danger-red: #da402b;
      --header-bg: #f5f6f7;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .window-container {
      background: var(--window-bg);
      width: 100%;
      max-width: 900px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border-color);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .window-header {
      background-color: var(--header-bg);
      padding: 12px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .window-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .window-controls {
      display: flex;
      gap: 6px;
    }

    .win-btn {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #cbd5e0;
    }

    .win-btn.close {
      background-color: #ff5f57;
    }

    .win-btn.min {
      background-color: #ffbd2e;
    }

    .win-btn.max {
      background-color: #28c940;
    }

    .main-content {
      padding: 24px;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel {
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 16px;
      background: #fff;
    }

    .panel-header {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      font-weight: 700;
      margin-bottom: 12px;
      border-bottom: 1px solid #ebebeb;
      padding-bottom: 8px;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .status-row:last-child {
      margin-bottom: 0;
    }

    .status-label {
      color: var(--text-secondary);
    }

    .status-value {
      font-weight: 600;
      color: var(--text-main);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      background: #e4e6eb;
      color: var(--text-secondary);
    }

    .status-badge.online {
      background: #e6f7e9;
      color: var(--success-green);
    }

    .status-badge.offline {
      background: #fde8e8;
      color: var(--danger-red);
    }

    .control-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .btn {
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover:not(:disabled) {
      background: #f7f8fa;
    }

    .btn:active:not(:disabled) {
      transform: translateY(1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary-blue);
      color: white;
      border-color: var(--primary-blue);
    }

    .btn-primary:hover:not(:disabled) {
      background: #166fe5;
    }

    .btn-danger {
      background: white;
      color: var(--danger-red);
      border-color: #fce8e6;
    }

    .btn-danger.active {
      background: var(--danger-red);
      color: white;
      border-color: var(--danger-red);
    }

    .btn-success {
      color: var(--success-green);
      border-color: #e6f7e9;
    }

    .btn-success.active {
      background: var(--success-green);
      color: white;
      border-color: var(--success-green);
    }

    .logs-panel {
      display: flex;
      flex-direction: column;
      height: 400px;
    }

    .logs-container {
      flex: 1;
      overflow-y: auto;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 12px;
      background: #fafafa;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 12px;
    }

    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid #f0f0f0;
      display: grid;
      grid-template-columns: 70px 40px 1fr;
      gap: 10px;
      align-items: start;
    }

    .log-time {
      color: #999;
    }

    .log-source {
      font-weight: bold;
      text-align: center;
      border-radius: 3px;
    }

    .log-source.ESP {
      color: var(--primary-blue);
    }

    .log-source.WEB {
      color: var(--danger-red);
    }

    .log-source.SRV {
      color: var(--success-green);
    }

    .log-msg {
      color: #333;
      word-break: break-all;
    }

    .empty-state {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-style: italic;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      .logs-panel {
        height: 300px;
      }
    }
  </style>
</head>

<body>
  <div class="window-container">
    <div class="window-header">
      <div class="window-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
          <rect x="9" y="9" width="6" height="6"></rect>
          <line x1="9" y1="1" x2="9" y2="4"></line>
          <line x1="15" y1="1" x2="15" y2="4"></line>
          <line x1="9" y1="20" x2="9" y2="23"></line>
          <line x1="15" y1="20" x2="15" y2="23"></line>
          <line x1="20" y1="9" x2="23" y2="9"></line>
          <line x1="20" y1="14" x2="23" y2="14"></line>
          <line x1="1" y1="9" x2="4" y2="9"></line>
          <line x1="1" y1="14" x2="4" y2="14"></line>
        </svg>
        ESP8266 Manager
      </div>
      <div class="window-controls">
        <div class="win-btn close"></div>
        <div class="win-btn min"></div>
        <div class="win-btn max"></div>
      </div>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <!-- Status Panel -->
        <div class="panel">
          <div class="panel-header">System Status</div>
          <div class="status-row">
            <span class="status-label">Device</span>
            <span class="status-badge" id="statusBadge">Checking...</span>
          </div>
          <div class="status-row">
            <span class="status-label">LED State</span>
            <span class="status-value" id="ledStateText">--</span>
          </div>
          <div class="status-row">
            <span class="status-label">Last Seen</span>
            <div class="status-value" id="lastSeen">--</div>
          </div>
        </div>

        <!-- Control Panel -->
        <div class="panel">
          <div class="panel-header">Controls</div>
          <div class="control-grid">
            <button class="btn btn-success" id="btnOn" onclick="setLED('on')">
              ON
            </button>
            <button class="btn btn-danger" id="btnOff" onclick="setLED('off')">
              OFF
            </button>
          </div>
        </div>

        <!-- Stats Panel -->
        <div class="panel">
          <div class="panel-header">Statistics</div>
          <div class="status-row">
            <span class="status-label">Total Logs</span>
            <span class="status-value" id="logCount">0</span>
          </div>
        </div>
      </div>

      <div class="panel logs-panel">
        <div class="panel-header">System Logs</div>
        <div class="logs-container" id="logs">
          <div class="empty-state">Waiting for activity...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Socket.IO Client Library -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
    // Initialize Socket.IO
    const socket = io();
    let currentLedState = 'off';
    let espOnline = false;
    let totalLogs = 0;

    socket.on('connect', () => {
      console.log('✅ Socket.IO connected:', socket.id);
    });

    socket.on('disconnect', () => {
      console.log('❌ Socket.IO disconnected');
    });

    // Real-time status updates
    socket.on('status', (data) => {
      espOnline = data.online;
      currentLedState = data.ledState;

      if (data.lastSeen) {
        const lastSeen = new Date(data.lastSeen);
        const now = new Date();
        const diff = Math.floor((now - lastSeen) / 1000);
        document.getElementById('lastSeen').textContent = diff < 60 ? `${diff}s ago` : 'Offline';
      } else {
        document.getElementById('lastSeen').textContent = '--';
      }

      updateUI();
    });

    // Real-time log updates
    socket.on('logs', (logs) => {
      totalLogs = logs.length;
      displayLogs(logs);
      document.getElementById('logCount').textContent = totalLogs;
    });

    async function setLED(state) {
      const btnOn = document.getElementById('btnOn');
      const btnOff = document.getElementById('btnOff');
      btnOn.disabled = true;
      btnOff.disabled = true;

      try {
        const res = await fetch('/set', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        // Updates will come via Socket.IO automatically
      } catch (err) {
        console.error('❌ Error:', err);
        alert('Failed to set LED state');
      } finally {
        btnOn.disabled = false;
        btnOff.disabled = false;
      }
    }

    function displayLogs(logs) {
      const container = document.getElementById('logs');

      if (logs.length === 0) {
        container.innerHTML = '<div class="empty-state">No activity yet</div>';
        return;
      }

      container.innerHTML = logs.map(log => `
        <div class="log-entry">
          <span class="log-time">${log.time}</span>
          <span class="log-source ${log.source}">${log.source}</span>
          <span class="log-msg">${log.msg}</span>
        </div>
      `).join('');

      container.scrollTop = container.scrollHeight;
    }

    function updateUI() {
      // Status Badge
      const statusBadge = document.getElementById('statusBadge');
      if (espOnline) {
        statusBadge.textContent = 'ONLINE';
        statusBadge.className = 'status-badge online';
      } else {
        statusBadge.textContent = 'OFFLINE';
        statusBadge.className = 'status-badge offline';
      }

      // LED Text
      document.getElementById('ledStateText').textContent = currentLedState.toUpperCase();

      // Buttons Highlighting
      const btnOn = document.getElementById('btnOn');
      const btnOff = document.getElementById('btnOff');

      // Reset classes
      btnOn.className = 'btn btn-success';
      btnOff.className = 'btn btn-danger';

      if (currentLedState === 'on') {
        btnOn.classList.add('active');
        btnOn.textContent = 'ON (Active)';
      } else {
        btnOn.textContent = 'ON';
      }

      if (currentLedState === 'off') {
        btnOff.classList.add('active');
        btnOff.textContent = 'OFF (Active)';
      } else {
        btnOff.textContent = 'OFF';
      }
    }

    // Initial state
    updateUI();
  </script>
</body>

</html>